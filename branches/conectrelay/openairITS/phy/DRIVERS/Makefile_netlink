CCC = gcc
KERNEL_MAIN_TYPE=$(shell echo `uname -r | cut -d. -f-2  | tr "." "_"`)
export KERNEL_MAIN_TYPE

SUBVERSION=$(shell echo `grep '^SUBLEVEL =' /usr/src/linux/Makefile | sed -e 's, ,,g' | sed -e 's/SUBLEVEL=//'`)
IS_KERNEL_SUBVERSION_GREATER_THAN_20=$(shell if [ $(SUBVERSION) -ge 20 ] ; then echo true ; fi)

EXTRA_CFLAGS += -DKERNEL$(KERNEL_MAIN_TYPE)
#-DOLD_REMAP

EXTRA_CFLAGS +=  -Wstrict-prototypes -fno-common -fno-strict-aliasing -pipe -mpreferred-stack-boundary=4 -freg-struct-return -ffreestanding -maccumulate-outgoing-args -funroll-loops -march=i686 -fomit-frame-pointer -nostdinc -O2

obj-m += exmimo_driver.o

exmimo_driver-objs = device.o fileops.o exmimo_if.o exmimo_main.o netlink_kernelapi.o netlink_rxhandler.o

all: user_sendpkt user_test user_test_rx_exmimo2pc

user_sendpkt:
	gcc -I .. -g netlink_user_sendpkt.c netlink_userapi.c -o netlink_user_sendpkt

user_test:
	gcc -I .. -g netlink_user_test.c netlink_userapi.c -o netlink_user_test

user_test_readwrite:
	gcc -I .. -g netlink_user_test_readwrite.c -o netlink_user_test_readwrite

user_test_rx_exmimo2pc:
	gcc -I .. -g netlink_user_test_rx_exmimo2pc.c netlink_userapi.c -o netlink_user_test_rx_exmimo2pc

test:
	echo $(exmimo_driver-objs)
	echo $(CFLAGS)
	echo $(EXTRA_CFLAGS)

clean:
	rm -f $(exmimo_driver-objs) *~ *.cmd .*.cmd netlink_user_test_readwrite netlink_user_test

ultraclean: clean
	rm -rf *~  *.o *.ko *.mod.* Module.* modules.* .tmp_versions
