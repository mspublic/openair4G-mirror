#!/bin/sh
# route entity ucf-file device effort bitgen-file path boardversion
#   (added parameter board-version so that we preprocess the EDIF netlist generated by
#    precision accordingly).
banner="############################################################################################"
echo $banner; echo "######################################### edif2ngd #########################################"; echo $banner
if [ $6 = 'precision' ] ; then
  echo "Preprocessing the EDIF netlist from Precision to add the 'CLKIN_PERIOD' parameter to instances 'dcm0' and 'dcm1'..."
  if [ $7 ] ; then
    if [ $7 -eq 0 -o $7 -eq 1 ] ; then
      dcm0_in_period='38.46153'
    elif [ $7 -eq 2 ] ; then
      dcm0_in_period='52.08333'
    else
      echo 'Error: uncorrect board version number while calling script '$0
      exit -1
    fi
  else
    echo 'Error: did not specify board version number while calling script '$0
    exit -1
  fi
  sed -i -e "s/(instance dcm0\(.*\)$/(instance dcm0\1\n      (property CLKIN_PERIOD (string \"$dcm0_in_period\"))/" \
         -e 's/(instance dcm1\(.*\)$/(instance dcm1\1\n      (property CLKIN_PERIOD (string \"65.104167\"))/' \
      $6/$1.edf
fi
echo "Executing command: edif2ngd $6/$1.edf"
edif2ngd $6/$1.edf
echo $banner; echo "######################################### ngdbuild #########################################"; echo $banner
echo "Executing command: ngdbuild $1.ngo -aul -uc $2 -p $3 -sd $7"
ngdbuild $1.ngo -aul -uc $2 -p $3 -sd $7
echo $banner; echo "########################################    map    #########################################"; echo $banner
#map -pr b -timing -ol $4 -p $3 $1
echo "Executing command: map -pr b -p $3 $1"
map -pr b -p $3 $1
echo $banner; echo "########################################    par   ##########################################"; echo $banner
echo "Executing command: par -ol $4 -w $1 $1.ncd"
par -ol $4 -w $1 $1.ncd 
echo $banner; echo "########################################   trce   ##########################################"; echo $banner
echo "Executing command: trce -v 25 $1.ncd $1.pcf"
trce -v 25 $1.ncd $1.pcf 
echo $banner; echo "########################################  bitgen  ##########################################"; echo $banner
echo "Executing command: bitgen $1 -d -l -m -w -f $5"
bitgen $1 -d -l -m -w -f $5
